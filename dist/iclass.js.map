{"version":3,"sources":["../src/iclass.ts"],"names":["noop","iClass","Interface","constructor","data","updatedCB","_updatedCB","_definition","_originalData","_initData","_proxy","Proxy","keyUpdated","key","_updatedData","$diff","getHandlers","handler","Handler","isInstance","isPrototypeOf","deserialize","serialize","$isInterface","$json","get","target","Object","keys","publicClassMethods","includes","undefined","set","value","isFunction","Error","originalData","updatedData","reduce","acc","definition"],"mappings":";;;;;;;;;AAAA;;;;AAEA,MAAMA,IAAI,GAAG,MAAM,IAAnB;;AAEO,MAAeC,MAAf,SAA8BC,eAA9B,CAAwC;AAG3CC,EAAAA,WAAW,CAAEC,IAAF,EAAmD;AAAA,QAA3BC,SAA2B,uEAANL,IAAM;AAC5D;;AAD4D;;AAAA,uCADxB,EACwB;;AAE5D,SAAKM,UAAL,GAAkBD,SAAlB;AACA,SAAKE,WAAL,GAAoB,EAApB;AACA,SAAKC,aAAL,GAAqB,EAArB;AACA,SAAKC,SAAL,GAAiBL,IAAjB;AACA,SAAKM,MAAL,GAAc,IAAIC,KAAJ,CAAU,IAAV,EAA4C,IAA5C,CAAd;AACA,WAAO,KAAKD,MAAZ;AACD;;AAEOE,EAAAA,UAAR,CAAmBC,GAAnB,EAA+B;AAC7B,SAAKC,YAAL,CAAkBD,GAAlB,IAAyB,KAAKH,MAAL,CAAYG,GAAZ,EAAiBE,KAA1C;;AACA,SAAKT,UAAL;AACD;;AAESU,EAAAA,WAAV,CAAsBH,GAAtB,EAAkC;AAChC,UAAMI,OAAO,GAAiB,KAAKV,WAAL,CAAiBM,GAAjB,CAA9B;AACA,UAAMK,OAAO,GAA2B,KAAKX,WAAL,CAAiBM,GAAjB,CAAxC;;AACA,UAAMM,UAAU,GAAGjB,gBAAUkB,aAAV,CAAwBF,OAAxB,CAAnB;;AACA,WAAO;AAACD,MAAAA,OAAD;AAAUC,MAAAA,OAAV;AAAmBC,MAAAA;AAAnB,KAAP;AACD;;AAESE,EAAAA,WAAV,CAAsBR,GAAtB,EAAkCT,IAAlC,EAA4C;AAC1C,UAAM;AAACa,MAAAA,OAAD;AAAUC,MAAAA,OAAV;AAAmBC,MAAAA;AAAnB,QAAiC,KAAKH,WAAL,CAAiBH,GAAjB,CAAvC;;AACA,QAAIM,UAAJ,EAAgB;AACd,aAAO,IAAID,OAAJ,CAAYd,IAAZ,EAAkB,MAAM,KAAKQ,UAAL,CAAgBC,GAAhB,CAAxB,CAAP;AACD,KAFD,MAEO;AACL,aAAOI,OAAO,CAACJ,GAAD,EAAMT,IAAN,CAAd;AACD;AACF;;AAESkB,EAAAA,SAAV,CAAoBT,GAApB,EAAgCT,IAAhC,EAA0C;AACxC,UAAM;AAACa,MAAAA,OAAD;AAAUC,MAAAA,OAAV;AAAmBC,MAAAA;AAAnB,QAAiC,KAAKH,WAAL,CAAiBH,GAAjB,CAAvC;;AACA,QAAIM,UAAU,KAAIf,IAAJ,aAAIA,IAAJ,uBAAIA,IAAI,CAAEmB,YAAV,CAAd,EAAsC;AACpC,aAAOnB,IAAI,CAACoB,KAAZ;AACD,KAFD,MAEO;AACL,aAAOP,OAAO,CAACK,SAAR,CAAkBT,GAAlB,EAAuBT,IAAvB,CAAP;AACD;AACF;;AAEDqB,EAAAA,GAAG,CAAEC,MAAF,EAAiBb,GAAjB,EAAmD;AAAA;;AACpD,UAAMM,UAAkB,4BAAG,KAAKX,aAAL,CAAmBK,GAAnB,CAAH,0DAAG,sBAAyBU,YAApD;;AACA,QAAII,MAAM,CAACC,IAAP,CAAYC,wBAAZ,EAAgCC,QAAhC,CAAiDjB,GAAjD,CAAJ,EAA2D;AACvD,aAAkB,KAAyBA,GAAzB,CAAX,EAAP;AACH;;AACD,WAAQM,UAAU,IAAI,KAAKL,YAAL,CAAkBD,GAAlB,MAA2BkB,SAA1C,GAAuD,KAAKvB,aAAL,CAAmBK,GAAnB,CAAvD,GAAiF,KAAKC,YAAL,CAAkBD,GAAlB,CAAxF;AACD;;AACDmB,EAAAA,GAAG,CAAEN,MAAF,EAAiBb,GAAjB,EAA6BoB,KAA7B,EAAwC;AAC3C,QAAI;AACA,YAAMd,UAAU,GAAGjB,gBAAUkB,aAAV,CAAwBa,KAAxB,CAAnB;;AACA,YAAMC,UAAU,GAAG,OAAOD,KAAP,KAAiB,UAApC;;AACA,UAAId,UAAU,IAAIe,UAAlB,EAA8B;AAC5B,aAAK3B,WAAL,CAAiBM,GAAjB,IAAwBoB,KAAxB;AACA,aAAKzB,aAAL,CAAmBK,GAAnB,IAA0B,KAAKQ,WAAL,CAAiBR,GAAjB,EAAsB,KAAKJ,SAAL,CAAeI,GAAf,CAAtB,CAA1B;AACD,OAHD,MAGO;AACL,aAAKC,YAAL,CAAkBD,GAAlB,IAAyB,KAAKQ,WAAL,CAAiBR,GAAjB,EAAsBoB,KAAtB,CAAzB;;AACA,aAAK3B,UAAL,CAAgBO,GAAhB,EAAqBoB,KAArB;AACD;;AACD,aAAO,IAAP;AACH,KAXD,CAWE,gBAAM;AACJ,YAAM,IAAIE,KAAJ,aAActB,GAAd,iCAAN;AACH;AACA;;AAEME,EAAAA,KAAP,GAAgC;AAC9B,UAAMqB,YAA4B,GAAoB,KAAK5B,aAA3D;AACA,UAAM6B,WAA2B,GAAG,KAAKvB,YAAzC;AACA,UAAMV,IAAoB,GAAG,EAA7B;AACA,WAAOuB,MAAM,CAACC,IAAP,CAAYS,WAAZ,EAAyBC,MAAzB,CAAgC,CAACC,GAAD,EAAM1B,GAAN,KAAc;AACnD,UAAIuB,YAAY,CAACvB,GAAD,CAAZ,KAAsBwB,WAAW,CAACxB,GAAD,CAArC,EAA4C;AAC1C,YAAIwB,WAAW,CAACxB,GAAD,CAAX,CAAiBU,YAArB,EAAmC;AACjCgB,UAAAA,GAAG,CAAC1B,GAAD,CAAH,GAAWwB,WAAW,CAACxB,GAAD,CAAX,CAAiBW,KAA5B;AACD,SAFD,MAEO;AACLe,UAAAA,GAAG,CAAC1B,GAAD,CAAH,GAAWwB,WAAW,CAACxB,GAAD,CAAtB;AACD;AACF;;AACD,aAAO0B,GAAP;AACD,KATM,EASJnC,IATI,CAAP;AAUD;;AAEMoB,EAAAA,KAAP,GAAgC;AAC9B,UAAMgB,UAA0E,GAAG,KAAKjC,WAAxF;AACA,UAAMH,IAAoB,GAAG,KAAKM,MAAlC;AACA,WAAOiB,MAAM,CAACC,IAAP,CAAYY,UAAZ,EAAwBF,MAAxB,CAA+B,CAACC,GAAD,EAAsB1B,GAAtB,KAA8B;AAClE0B,MAAAA,GAAG,CAAC1B,GAAD,CAAH,GAAW,KAAKS,SAAL,CAAeT,GAAf,EAAoBT,IAAI,CAACS,GAAD,CAAxB,CAAX;AACA,aAAO0B,GAAP;AACD,KAHM,EAGJ,EAHI,CAAP;AAID;;AA1F0C","sourcesContent":["import { Interface, InterfaceLike, InterfaceClass, Dictionary, Deserializer, publicClassMethods } from './base'\n\nconst noop = () => null\n\nexport abstract class iClass extends Interface {\n    protected _definition: Dictionary<Deserializer|Interface|InterfaceClass|InterfaceLike>\n    protected _initData:Dictionary<any> = {} \n    constructor (data:Dictionary<any>, updatedCB:Function = noop) {\n      super()\n      this._updatedCB = updatedCB\n      this._definition =  {}\n      this._originalData = {}\n      this._initData = data\n      this._proxy = new Proxy(this, <ProxyHandler<any>><unknown>this)\n      return this._proxy\n    }\n  \n    private keyUpdated(key:string) {\n      this._updatedData[key] = this._proxy[key].$diff\n      this._updatedCB()\n    }\n  \n    protected getHandlers(key:string) {\n      const handler = <Deserializer>this._definition[key]\n      const Handler = <InterfaceLike><unknown>this._definition[key]\n      const isInstance = Interface.isPrototypeOf(Handler)\n      return {handler, Handler, isInstance}\n    }\n  \n    protected deserialize(key:string, data:any) {\n      const {handler, Handler, isInstance} = this.getHandlers(key)\n      if (isInstance) {\n        return new Handler(data, () => this.keyUpdated(key))\n      } else {\n        return handler(key, data)\n      } \n    }\n  \n    protected serialize(key:string, data:any) {\n      const {handler, Handler, isInstance} = this.getHandlers(key)\n      if (isInstance || data?.$isInterface) {\n        return data.$json\n      } else {\n        return handler.serialize(key, data)\n      } \n    }  \n\n    get (target:iClass, key:string|number):Dictionary<any>{\n      const isInstance:boolean = this._originalData[key]?.$isInterface\n      if (Object.keys(publicClassMethods).includes(<string>key)) {\n          return (<Function>this[<publicClassMethods>key])()\n      }\n      return (isInstance || this._updatedData[key] === undefined) ? this._originalData[key] : this._updatedData[key]\n    }\n    set (target:iClass, key:string, value:any) {\n    try {\n        const isInstance = Interface.isPrototypeOf(value)\n        const isFunction = typeof value === 'function'\n        if (isInstance || isFunction) {\n          this._definition[key] = value\n          this._originalData[key] = this.deserialize(key, this._initData[key])\n        } else {\n          this._updatedData[key] = this.deserialize(key, value)\n          this._updatedCB(key, value)  \n        }\n        return true\n    } catch {\n        throw new Error(`\"${key}\" not found in definitions`)\n    }\n    }\n  \n    public $diff ():Dictionary<any> {\n      const originalData:Dictionary<any> = <Dictionary<any>>this._originalData\n      const updatedData:Dictionary<any> = this._updatedData\n      const data:Dictionary<any> = {}\n      return Object.keys(updatedData).reduce((acc, key) => {\n        if (originalData[key] !== updatedData[key]) {\n          if (updatedData[key].$isInterface) {\n            acc[key] = updatedData[key].$json\n          } else {\n            acc[key] = updatedData[key]\n          }\n        }\n        return acc\n      }, data)\n    }\n  \n    public $json ():Dictionary<any> {\n      const definition:Dictionary<Deserializer|Interface|InterfaceClass|InterfaceLike> = this._definition\n      const data:Dictionary<any> = this._proxy\n      return Object.keys(definition).reduce((acc:Dictionary<any>, key) => {\n        acc[key] = this.serialize(key, data[key])\n        return acc\n      }, {})\n    }\n  }"],"file":"iclass.js"}